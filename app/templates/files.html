{% extends "base.html" %}
{% block content %}
<h1>Archivos y documentos por departamento</h1>

<button onclick="window.print()" style="float:right;">Imprimir</button>

<!-- Filtro por departamento (GET) -->
<form method="get" action="/files/ui">
  <label>Departamento:
    <select name="department" onchange="this.form.submit()">
      {% for value, label in departments %}
        <option value="{{ value }}" {% if value == selected_department %}selected{% endif %}>
          {{ label }}
        </option>
      {% endfor %}
    </select>
  </label>
  <noscript><button type="submit">Filtrar</button></noscript>
</form>

<!-- Subida de archivo, respeta el departamento seleccionado -->
<form method="post" action="/files/upload" enctype="multipart/form-data" style="margin-top:1rem;">
  <input type="hidden" name="department" value="{{ selected_department }}">
  <label>Elegir archivo</label>
  <input type="file" name="upfile" required>
  <button type="submit">Subir archivo</button>
</form>

<!-- Crear documento interno (CareWave Doc) -->
<section style="margin-top:1.5rem;">
  <h2>Crear documento interno (CareWave Doc)</h2>
  <form method="post" action="/files/docs/create">
    <input type="hidden" name="department" value="{{ selected_department }}">
    <div>
      <label>Título</label>
      <input type="text" name="title" placeholder="Acta de reunión, protocolo, etc." required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Contenido</label><br>
      <textarea name="content" rows="6" style="width:100%;" placeholder="Escribe aquí el contenido del documento" required></textarea>
    </div>
    <button type="submit" style="margin-top:0.8rem;">Guardar documento</button>
  </form>
</section>

<!-- Listado de archivos físicos -->
<section style="margin-top:1.5rem;">
  <h2>Archivos subidos</h2>
  <table>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Departamento</th>
      <th>Subido por</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
    {% for f in files %}
      <tr>
        <td>{{ f.id }}</td>
        <td>{{ f.filename }}</td>
        <td>
          {% for value, label in departments %}
            {% if value == f.department %}
              {{ label }}
            {% endif %}
          {% endfor %}
        </td>
        <td>{{ f.uploaded_by }}</td>
        <td>{{ f.uploaded_at }}</td>
        <td>
          <form method="post"
                action="/files/{{ f.id }}/delete?department={{ selected_department }}"
                onsubmit="return confirm('¿Eliminar este archivo?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not files %}
      <tr><td colspan="6">Todavía no hay archivos en este departamento.</td></tr>
    {% endif %}
  </table>
</section>

<!-- Listado de documentos internos -->
<section style="margin-top:1.5rem;">
  <h2>Documentos internos (CareWave Docs)</h2>
  <table>
    <tr>
      <th>ID</th>
      <th>Título</th>
      <th>Departamento</th>
      <th>Creado por</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
    {% for d in documents %}
      <tr>
        <td>{{ d.id }}</td>
        <td>{{ d.title }}</td>
        <td>
          {% for value, label in departments %}
            {% if value == d.department %}
              {{ label }}
            {% endif %}
          {% endfor %}
        </td>
        <td>{{ d.created_by }}</td>
        <td>{{ d.created_at }}</td>
        <td>
          <a href="/files/docs/{{ d.id }}" target="_blank">Ver / Imprimir</a>
          <form method="post"
                action="/files/docs/{{ d.id }}/delete?department={{ selected_department }}"
                style="display:inline;"
                onsubmit="return confirm('¿Eliminar este documento?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not documents %}
      <tr><td colspan="6">No hay documentos internos en este departamento.</td></tr>
    {% endif %}
  </table>
</section>
{% endblock %}