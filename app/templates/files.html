{% extends "base.html" %}
{% block content %}

<h1>Archivos y documentos por departamento</h1>

<!-- Selección de departamento -->
<form method="get" action="/files/ui" style="margin-bottom:1rem;">
  <label>Departamento:</label>
  <select name="department" onchange="this.form.submit()">
    {% for value, label in departments %}
      <option value="{{ value }}"
              {% if selected_department == value %}selected{% endif %}>
        {{ label }}
      </option>
    {% endfor %}
  </select>
  <noscript><button type="submit">Ver</button></noscript>
</form>

<!-- ================== SUBIR ARCHIVO ================== -->
<section style="margin-bottom:2rem;">
  <h2>Subir archivo</h2>
  <form method="post"
        action="/files/upload"
        enctype="multipart/form-data">
    <input type="hidden" name="department" value="{{ selected_department }}">
    <div>
      <label>Elegir archivo</label>
      <input type="file" name="uploaded_file" required>
      <button type="submit">Subir archivo</button>
    </div>
  </form>
</section>

<!-- ================== CREAR DOCUMENTO INTERNO ================== -->
<section style="margin-bottom:2rem;">
  <h2>Crear documento (CareWave Doc)</h2>
  <form method="post" action="/files/docs/create">
    <input type="hidden" name="department" value="{{ selected_department }}">
    <div>
      <label>Título</label>
      <input type="text" name="title" placeholder="Acta de reunión, checklist, etc." required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Contenido</label><br>
      <textarea name="content" rows="6" cols="80"
                placeholder="Escribe aquí el contenido del documento"></textarea>
    </div>
    <button type="submit" style="margin-top:0.8rem;">Guardar documento</button>
  </form>
</section>

<!-- ================== ARCHIVOS SUBIDOS ================== -->
<section style="margin-bottom:2rem;">
  <h2>Archivos subidos</h2>
  <table>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Departamento</th>
      <th>Subido por</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
    {% for f in files %}
      <tr>
        <td>{{ f.id }}</td>
        <td>{{ f.filename }}</td>
        <td>{{ f.department }}</td>
        <td>{{ f.uploaded_by }}</td>
        <td>{{ f.uploaded_at }}</td>
        <td>
          <!-- enlace de descarga/abrir si sirves los archivos estáticos -->
          {% if f.stored_path %}
            <a href="/{{ f.stored_path|replace('\\', '/') }}" target="_blank">Ver</a>
          {% endif %}
          <form method="post"
                action="/files/files/{{ f.id }}/delete"
                style="display:inline;"
                onsubmit="return confirm('¿Eliminar este archivo?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not files %}
      <tr><td colspan="6">Todavía no hay archivos en este departamento.</td></tr>
    {% endif %}
  </table>
</section>

<!-- ================== DOCUMENTOS INTERNOS ================== -->
<section>
  <h2>Documentos internos (CareWave Docs)</h2>
  <table>
    <tr>
      <th>ID</th>
      <th>Título</th>
      <th>Departamento</th>
      <th>Creado por</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
    {% for d in docs %}
      <tr>
        <td>{{ d.id }}</td>
        <td>{{ d.title }}</td>
        <td>{{ d.department }}</td>
        <td>{{ d.created_by }}</td>
        <td>{{ d.created_at }}</td>
        <td>
          <details>
            <summary>Ver contenido</summary>
            <pre style="white-space:pre-wrap;">{{ d.content }}</pre>
          </details>
          <form method="post"
                action="/files/docs/{{ d.id }}/delete"
                style="display:inline;"
                onsubmit="return confirm('¿Eliminar este documento?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not docs %}
      <tr><td colspan="6">Todavía no hay documentos internos en este departamento.</td></tr>
    {% endif %}
  </table>
</section>

{% endblock %} 
