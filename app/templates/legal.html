{% extends "base.html" %}
{% block content %}

<div style="display:flex; align-items:center; justify-content:space-between;">
  <h1>Legal &amp; Compliance</h1>
  <button type="button"
          onclick="window.print()"
          style="border:none; background:transparent; cursor:pointer; font-size:0.9rem;">
    üñ® Imprimir
  </button>
</div>

<p>
  Gesti√≥n avanzada de documentos legales, RGPD, normativas sanitarias y contratos
  (incluyendo AI ACT y propiedad intelectual de datasets).
</p>

<!-- ================== Documentos legales ================== -->
<section style="margin-top:1.5rem;">
  <h2>Documentos legales</h2>

  <form method="post"
        action="/legal/documents/create"
        enctype="multipart/form-data">

    <div>
      <label for="title">T√≠tulo del documento</label>
      <input id="title"
             type="text"
             name="title"
             placeholder="NDA proveedor X"
             required>
    </div>

    <div style="margin-top:0.5rem;">
      <label for="category">Categor√≠a</label>
      <select id="category" name="category" required>
        <!-- opci√≥n placeholder para que el desplegable se vea claro -->
        <option value="" disabled selected>-- Selecciona una categor√≠a --</option>
        {% for value, label in legal_categories %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="margin-top:0.5rem;">
      <label for="file">Adjuntar archivo (PDF, DOCX, XLSX, etc.)</label>
      <input id="file" type="file" name="file">
    </div>

    <button type="submit" style="margin-top:0.8rem;">Crear documento</button>
  </form>

  <h3 style="margin-top:1rem;">Listado de documentos legales</h3>
  <table>
    <tr>
      <th>T√≠tulo</th>
      <th>Categor√≠a</th>
      <th>Archivo</th>
      <th>Creado por</th>
      <th>Estado de firma</th>
      <th>Acciones</th>
    </tr>
    {% for doc in documents %}
      <tr>
        <td>{{ doc.title }}</td>
        <td>{{ doc.category }}</td>
        <td>
          {% if doc.file_path %}
            <a href="/legal/documents/{{ doc.id }}/file" target="_blank">üìÑ Ver archivo</a>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>{{ doc.created_by }} ({{ doc.created_at }})</td>
        <td>
          {% if doc.is_signed %}
            ‚úÖ Firmado por {{ doc.signed_by }} el {{ doc.signed_at }}
          {% else %}
            ‚ùå Pendiente
          {% endif %}
        </td>
        <td>
          {% if not doc.is_signed %}
            <form method="post"
                  action="/legal/documents/{{ doc.id }}/sign"
                  style="display:inline;">
              <button type="submit">Firmar</button>
            </form>
          {% endif %}
          <form method="post"
                action="/legal/documents/{{ doc.id }}/delete"
                style="display:inline;"
                onsubmit="return confirm('¬øEliminar este documento legal?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not documents %}
      <tr><td colspan="6">Todav√≠a no hay documentos legales registrados.</td></tr>
    {% endif %}
  </table>
</section>

<!-- ================== RGPD: RAT (Registro de actividades) ================== -->
<section style="margin-top:1.5rem;">
  <h2>RGPD ‚Äì Registro de actividades de tratamiento (RAT)</h2>

  <form method="post" action="/legal/rgpd/rat/create">
    <div>
      <label>Actividad de tratamiento</label>
      <input type="text" name="activity_name" placeholder="Gesti√≥n de pacientes, n√≥minas, etc." required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Responsable</label>
      <input type="text" name="responsible" placeholder="DPD, Responsable, etc." required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Descripci√≥n</label>
      <input type="text" name="description">
    </div>
    <div style="margin-top:0.5rem;">
      <label>Nivel de riesgo</label>
      <select name="risk_level" required>
        <option value="bajo">Bajo</option>
        <option value="medio">Medio</option>
        <option value="alto">Alto</option>
      </select>
    </div>
    <button type="submit" style="margin-top:0.8rem;">A√±adir actividad RAT</button>
  </form>

  <h3 style="margin-top:1rem;">Actividades registradas</h3>
  <table>
    <tr>
      <th>Actividad</th>
      <th>Responsable</th>
      <th>Descripci√≥n</th>
      <th>Riesgo</th>
      <th>Creado por</th>
      <th>Acciones</th>
    </tr>
    {% for r in rgpd_records %}
      <tr>
        <td>{{ r.activity_name }}</td>
        <td>{{ r.responsible }}</td>
        <td>{{ r.description or '' }}</td>
        <td>{{ r.risk_level }}</td>
        <td>{{ r.created_by }} ({{ r.created_at }})</td>
        <td>
          <form method="post"
                action="/legal/rgpd/rat/{{ r.id }}/delete"
                onsubmit="return confirm('¬øEliminar este registro RAT?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not rgpd_records %}
      <tr><td colspan="6">Todav√≠a no hay actividades registradas.</td></tr>
    {% endif %}
  </table>
</section>

<!-- ================== RGPD: An√°lisis de riesgos ================== -->
<section style="margin-top:1.5rem;">
  <h2>RGPD ‚Äì An√°lisis de riesgos</h2>

  <form method="post" action="/legal/rgpd/risk/create">
    <div>
      <label>T√≠tulo del an√°lisis</label>
      <input type="text" name="title" placeholder="Riesgos en tratamiento de datos de salud" required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Riesgo identificado</label>
      <input type="text" name="risk" required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Medidas de mitigaci√≥n</label>
      <input type="text" name="mitigation" required>
    </div>
    <button type="submit" style="margin-top:0.8rem;">A√±adir an√°lisis</button>
  </form>

  <h3 style="margin-top:1rem;">An√°lisis de riesgos registrados</h3>
  <table>
    <tr>
      <th>T√≠tulo</th>
      <th>Riesgo</th>
      <th>Mitigaci√≥n</th>
      <th>Creado por</th>
      <th>Acciones</th>
    </tr>
    {% for ra in risk_analyses %}
      <tr>
        <td>{{ ra.title }}</td>
        <td>{{ ra.risk }}</td>
        <td>{{ ra.mitigation }}</td>
        <td>{{ ra.created_by }} ({{ ra.created_at }})</td>
        <td>
          <form method="post"
                action="/legal/rgpd/risk/{{ ra.id }}/delete"
                onsubmit="return confirm('¬øEliminar este an√°lisis de riesgos?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not risk_analyses %}
      <tr><td colspan="5">Todav√≠a no hay an√°lisis de riesgos registrados.</td></tr>
    {% endif %}
  </table>
</section>

<!-- ================== Normativas sanitarias UE / EEUU ================== -->
<section style="margin-top:1.5rem;">
  <h2>Normativas sanitarias (UE / EEUU)</h2>

  <form method="post" action="/legal/health/create" enctype="multipart/form-data">
    <div>
      <label>Regi√≥n</label>
      <select name="region" required>
        <option value="UE">UE</option>
        <option value="US">EEUU</option>
      </select>
    </div>
    <div style="margin-top:0.5rem;">
      <label>T√≠tulo</label>
      <input type="text" name="title" placeholder="Norma sanitaria X" required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Descripci√≥n</label>
      <input type="text" name="description">
    </div>
    <div style="margin-top:0.5rem;">
      <label>Documento asociado (opcional)</label>
      <input type="file" name="file">
    </div>
    <button type="submit" style="margin-top:0.8rem;">A√±adir normativa</button>
  </form>

  <h3 style="margin-top:1rem;">Normativas registradas</h3>
  <table>
    <tr>
      <th>Regi√≥n</th>
      <th>T√≠tulo</th>
      <th>Descripci√≥n</th>
      <th>Documento</th>
      <th>Creado por</th>
      <th>Acciones</th>
    </tr>
    {% for n in health_norms %}
      <tr>
        <td>{{ n.region }}</td>
        <td>{{ n.title }}</td>
        <td>{{ n.description or '' }}</td>
        <td>
          {% if n.file_path %}
            <a href="{{ '/' + n.file_path }}" target="_blank">Ver</a>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>{{ n.created_by }} ({{ n.created_at }})</td>
        <td>
          <form method="post"
                action="/legal/health/{{ n.id }}/delete"
                onsubmit="return confirm('¬øEliminar esta normativa?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not health_norms %}
      <tr><td colspan="6">Todav√≠a no hay normativas sanitarias registradas.</td></tr>
    {% endif %}
  </table>
</section>

<!-- ================== Contratos CareWave Health ================== -->
<section style="margin-top:1.5rem;">
  <h2>Contratos CareWave Health</h2>

  <form method="post" action="/legal/carewave/create" enctype="multipart/form-data">
    <div>
      <label>T√≠tulo del contrato</label>
      <input type="text" name="title" placeholder="Contrato proveedor Y" required>
    </div>
    <div style="margin-top:0.5rem;">
      <label>Documento de contrato</label>
      <input type="file" name="file">
    </div>
    <button type="submit" style="margin-top:0.8rem;">Crear contrato CareWave</button>
  </form>

  <h3 style="margin-top:1rem;">Contratos registrados</h3>
  <table>
    <tr>
      <th>T√≠tulo</th>
      <th>Documento</th>
      <th>Firmas</th>
      <th>Acciones</th>
    </tr>
    {% for c in carewave_contracts %}
      <tr>
        <td>{{ c.title }}</td>
        <td>
          {% if c.file_path %}
            <a href="{{ '/' + c.file_path }}" target="_blank">Ver contrato</a>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>
          Empresa:
          {% if c.signed_by_company %}‚úÖ{% else %}‚ùå{% endif %}
          &nbsp;|&nbsp;
          Partner:
          {% if c.signed_by_partner %}‚úÖ{% else %}‚ùå{% endif %}
        </td>
        <td>
          {% if not c.signed_by_company %}
            <form method="post"
                  action="/legal/carewave/{{ c.id }}/sign/company"
                  style="display:inline;">
              <button type="submit">Firma empresa</button>
            </form>
          {% endif %}
          {% if not c.signed_by_partner %}
            <form method="post"
                  action="/legal/carewave/{{ c.id }}/sign/partner"
                  style="display:inline;">
              <button type="submit">Firma partner</button>
            </form>
          {% endif %}
          <form method="post"
                action="/legal/carewave/{{ c.id }}/delete"
                style="display:inline;"
                onsubmit="return confirm('¬øEliminar este contrato?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not carewave_contracts %}
      <tr><td colspan="4">Todav√≠a no hay contratos CareWave registrados.</td></tr>
    {% endif %}
  </table>
</section>

{% endblock %}
